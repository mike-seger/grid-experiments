<!DOCTYPE html>
<html>
    <head>
        <title>CSV UI (w2ui)</title>
        <!-- <link rel="stylesheet" type="text/css" href="./w2ui/w2ui.css"> -->
        <link rel="stylesheet" type="text/css" href="https://rawgit.com/vitmalina/w2ui/master/dist/w2ui.css">
        <script src="https://cdn.jsdelivr.net/npm/d3-dsv@3"></script>
        <script type="module">
            import { w2ui, w2toolbar, w2grid } 
//                from 'https://rawgit.com/vitmalina/w2ui/master/dist/w2ui.es6.min.js'
                from './w2ui/w2ui.es6.js'

            let entities = null
            let loadedEntity = null

            function isStatic() {
                const urlParams = new URLSearchParams(window.location.search)
                const isStatic = urlParams.get('static')
                return isStatic || location.port==8000 || location.port==8001 || location.host.includes(".github.io")
            }

            function getConfigUri() {
                const urlParams = new URLSearchParams(window.location.search)
                let configUri = urlParams.get('conf')
                if(!configUri) {
                    if(isStatic()) configUri = 'config.json'
                    else configUri = '/configuration'
                }
                return configUri
            }

            function getRemoteBaseUri() {
                const urlParams = new URLSearchParams(window.location.search)
                let remoteBaseUri = urlParams.get('rbase')
                if(!remoteBaseUri) {
                    if(isStatic()) remoteBaseUri = "../../../../../../../../data/"
                    else remoteBaseUri = "../../api/v1/admin/csv"
                }
                return remoteBaseUri
            }

            function grid2Csv(records) {
                console.log(records)
            }

            // function changes() {
            //     const changes = w2ui.grid.getChanges()
            //     w2ui.grid.mergeChanges()
            //     console.log('Changes were', changes)
            // }

            function loadEntity(entity) {
                console.log(entity)
                if(entity == null) return
                loadedEntity = entity

                function getSelectionText(grid) {
                    const changes = grid.getChanges()
                    //grid.save()
                    grid.mergeChanges()
                    grid.changes = changes
                    const selection = grid.getSelection(true)
                    const minCol = Math.min(...selection.map(cell => cell.column))
                    const maxCol = Math.max(...selection.map(cell => cell.column))
                    const minRecId = Math.min(...selection.map(cell => cell.recid))
                    const maxRecId = Math.max(...selection.map(cell => cell.recid))               
                    const rowIndexes = [...new Set(selection.map(cell => cell.index))].sort()
                    const colIndexes = [...new Set(selection.map(cell => cell.column))].sort()
                    const recIds = [...new Set(selection.map(cell => cell.recid))]
                    console.log("rows("+rowIndexes+") / cols("+minCol+"-"+maxCol+")")
                    
                    //const colIndexes = Array.from({length: maxCol-minCol+1}, (x, i) => i+minCol)
                    const values = rowIndexes.map(index => colIndexes.map(
                        colIndex => { return grid.getCellValue(index, colIndex) }) )

                    //const ranges = recIds.map(recid => { return [{ recid, column: minCol }, { recid, column: maxCol }] })
                    const range = [
                        { recid: minRecId, column: minCol }, 
                        { recid: maxRecId, column: maxCol }
                    ]
                    const selectedRecords = grid.getRangeData(range, true)
                        .filter(r => recIds.includes(r[0].record.recid))
                        .map(record => { return record.map(col => { return col.data }) })
                    
                    console.log(d3.tsvFormatBody(selectedRecords))
                    //console.log(grid.getRangeData(range, true))
                    //console.log(d3.tsvFormatBody(grid.getRangeData(range, false)))
                   //grid.getRangeData(range).filter()

                    const result = d3.tsvFormatBody(values)
                    console.log(d3.tsvFormatBody(values))
                    return result
                    //getCellValue(index, column_index, [summary], [extra])
                }

                var config = {
                    grid: {
                        name: 'grid',
                        selectType: 'cell',
                        recordHeight: 28,
                        liveSearch: true,
                        multiSearch: true,
                        resizable: true,
                        //sortable: true,
                        //reorderColumns: true,
                        //emptyRecords: false,
                        //reorderRows: true,
                        show: {
                            toolbar: true,
                            footer: true,
                            lineNumbers: true
                        },
                        style: 'font-size:16px; font-family: sans-serif; color:black;',
                        onDelete(event) {
                            event.detail.force = true
                        },
                        contextMenu: [
                            { id: 'copySelection', text: 'Copy selection', icon: 'w2ui-icon-check' },
                            { text: '--' },
                            { id: 'pasteBefore', text: 'Paste rows before', icon: 'w2ui-icon-paste' },
                            { id: 'pasteAfter', text: 'Paste rows after', icon: 'w2ui-icon-paste' },
                            { text: '--' },
                            { id: 'insertRowsBefore', text: 'Insert new rows before', icon: 'w2ui-icon-plus' },
                            { id: 'insertRowsAfter', text: 'Insert new rows after', icon: 'w2ui-icon-plus' },
                            { text: '--' },
                            { id: 'deleteRows', text: 'Delete selected rows', icon: 'w2ui-icon-cross' },
                        ],

                        onContextMenuClick(event) {
                            console.log(event)
                            console.log( this.getSelection(true) )
                            const menuId = event.detail.menuItem.id
                            switch(menuId) {
                                case 'copySelection': {
                                          //copy()
                                        navigator.clipboard.writeText(getSelectionText(this))
                                    }
                                    break;
                            }
                        },
                        columnClick() {}
                    }
                }

                const columnDefs = entity.attributes.map(attribute => {
                    let type = 'text'
                    switch(attribute.type) {
                        case "Int": type = 'int'; break
                        case "Float": type = 'float:2';  break
                        case "Date": type = 'text';  break
                        case "Enum": type = 'list'; break
                    }
                    let columnDefinition = { 
                        field: attribute.columnName, 
                        text: attribute.name,
                        sortable: true, 
                        editable: { type: type }
                    }

                    if(type === 'list') {
                        const list = attribute.enumConstants.map(
                            value => { return { id: val, text: val } }
                        )
                        columnDefinition.editable.items = list
                        columnDefinition.editable.type = 'select'
                        columnDefinition.editable.showAll = true
                    } else if(! (type === 'text')) {
                        columnDefinition.render = type
                        columnDefinition.editable.type = type
                    }
                    return columnDefinition
                })
                let grid = new w2grid(config.grid)
                // grid.on('*', (event) => {
                //     console.log(event)
                // })

                w2ui.grid.columns = columnDefs
                w2ui.grid.lineNumberWidth = 58
                w2ui.grid.multiSearch = true

                const csvUri = getRemoteBaseUri()+entity.getUri
                const gridElement = document.getElementById("grid")
                fetch(csvUri)
                    .then((response) => response.text())
                    .then((csv) => {
                        const data = d3.csvParse(csv)
                        for (var i = 0; i < data.length; i++) data[i].recid = i
                        w2ui.grid.records = data
                        w2ui.grid.total = w2ui.grid.records.length
                        w2ui.grid.buffered = w2ui.grid.total
                        w2ui.grid.searches.forEach(search => { search.operator = 'contains' })
                        w2ui.grid.render(gridElement)
                        w2ui.grid.focus()
                    }
                )
            }

            function createToolbar(entities) {
                const entityItens = Object.keys(entities).map(key => 
                    { return { id: key, text: entities[key].name } }
                )
                const buttonStyle = 'font-family: icomoon; font-size: 17px;'

                new w2toolbar({
                    box: '#toolbar',
                    name: 'toolbar',
                    items: [
                        { type: 'menu-radio', id: 'entities',
                            text(item) {
                                const text = item.get(item.selected)?.text
                                if(text === undefined) return "Select entity..."
                                return text
                            },
                            style: 'width: 210px;',
                            items: entityItens 
                        },
                        { type: 'break' },
                        { type: 'button', 
                            id: 'save', 
                            style: buttonStyle,
                            text: '&#xe903;'
                        },
                        { type: 'menu-radio', id: 'format',
                            text(item) { return item.get(item.selected)?.text },
                            selected: 'TSV',
                            style: 'width: 50px; padding-right: 5px;',
                            items: [
                                { id: 'TSV', text: 'TSV' },
                                { id: 'CSV', text: 'CSV' },
                            ]
                        },
                        { type: 'button', 
                            id: 'download', 
                            style: buttonStyle,
                            text: '&#xe90c;'
                        },
                        { type: 'button', 
                            id: 'upload', 
                            style: buttonStyle,
                            text: '&#xe90b;'
                        },
                        { type: 'break' },
                        { type: 'button',
                            id: 'refresh',
                            style: buttonStyle,
                            text: '&#xe908;'
                        },
                        { type: 'spacer' },
                        { type: 'button', id: 'help', text: '?' }

                    ]
                })

                w2ui.toolbar.on('*', (event) => {
                    if(event.type === 'click') {
                        switch(event.target.replace(/:.*/, '')){
                            case "save":
                                console.log('save')
                                changes()
                                break

                            case "upload":
                                console.log('upload')
                                break

                            case "download":
                                console.log('download')
                                grid2Csv(w2ui.grid.records)
                                break

                            case "refresh":
                                console.log('refresh')
                                loadEntity(loadedEntity)
                                break

                            case "entities":
                                if(event.target.indexOf(':')>0) {
                                    const key = event.target.replace(/.*:/, '')
                                    loadEntity(entities[key])
                                }
                                break

                            case "format":
                                if(event.target.indexOf(':')>0)
                                    console.log('format -> '+event.target.replace(/.*:/, ''))
                                break
                            
                            default: 
                                console.log('default: '+event.target); break
                        }
                    }
                })
            }

            async function loadConfiguration() {
                const configUrl = getRemoteBaseUri() + getConfigUri()
                const response = await fetch(configUrl)
                const configuration = await response.json()
                console.log(configuration)
                entities = configuration.entities
                createToolbar(entities)
            }

            addEventListener('load', (event) => { loadConfiguration() });
        </script>
        
        <style> 
            :root { --main-tb-height: 27px; }

            body * {
                font-family: sans-serif;
                font-size: 16px;
            }

            @font-face {
                font-family: 'icomoon';
                src: 
                    url('fonts/icomoon.ttf') format('truetype'),
                    url('fonts/icomoon.svg#icomoon') format('svg');
                font-weight: normal;
                font-style: normal;
                font-display: swap;
            }

            #toolbar * {
                font-size: 16px;
                color: black;
                background-color: white;
            }

            .w2ui-toolbar {
                padding: 0 !important;
            }

            #toolbar .w2ui-toolbar {
                height: var(--main-tb-height) !important;
                border: none !important;
                margin: 0 !important;
                padding: 2px !important;
                background-color: white;
            }

            #toolbar .w2ui-tb-button {
                height: calc(var(--main-tb-height) - 6px) !important;
                border: none !important;
                padding-left: 3px;
            }

            #toolbar .w2ui-tb-button:hover, #toolbar .w2ui-tb-button:hover * {
                background-color: rgb(117, 167, 221) !important;
                color: white;
            }

            #toolbar .w2ui-tb-break {
                margin-top: 0;
                height: calc(var(--main-tb-height) - 8px) !important;
            }

            #toolbar .w2ui-tb-text {
                padding: 0 0 0 3px !important;
            }

            #toolbar .w2ui-tb-line {
                padding: 2px !important;
                border: 1px solid rgb(206, 206, 206) !important;
                min-height: var(--main-tb-height) !important;
                height: calc(var(--main-tb-height) - 6px) !important;
            }

            #grid {
                position: absolute;
                top: calc(var(--main-tb-height) + 8px);
                left: 8px;
                height: calc(100% - var(--main-tb-height) - 16px);
                width: calc(100% - 16px);
            }

            .w2ui-grid {
                border: 0 1px 1px 1px solid #e1e1e1 !important;
                border-radius: 0 !important;
                overflow: hidden!important;
                margin-top: -1px !important;
            }

            .w2ui-grid .w2ui-grid-toolbar {
                padding: 4px 4px 4px 0 !important;
            }

            .w2ui-search-all, 
            #tb_grid_toolbar_item_w2ui-search > * > *:not(.w2ui-action) {
                background-color: white !important;
            }

            .w2ui-col-header,
            .w2ui-col-number {
                font-weight: 600;
                color: black !important;
            }

            #tb_grid_toolbar_item_w2ui-reload {
                display: none;
            }

            .w2ui-grid .w2ui-grid-body table .w2ui-col-selected,
            .w2ui-grid .w2ui-grid-body table .w2ui-row-selected {
                background-color: rgb(206, 226, 255) !important;
            }

            .w2ui-grid .w2ui-grid-toolbar .w2ui-grid-searches {
                margin: 7px -20px 0px -20px;
            }

            .w2ui-grid-toolbar .w2ui-reset .w2ui-toolbar {
                margin-top: 3px;
                margin-bottom: 0;
            }
        </style>
    </head>

    <body>
        <div id="toolbar"></div>
        <div id="grid"></div>
    </body>
</html>