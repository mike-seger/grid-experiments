<html>
<head>
	
	<link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />
	<link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" /> 
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	
	<script src="https://jsuites.net/v4/jsuites.js"></script>
	<script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/d3-dsv@3"></script>

	<link rel="stylesheet" href="jexcel-custom.css" type="text/css" />

	<style>
		body, html {
			font-family: sans-serif;
			width: calc(100%-8px);
			height: 100%;
			overflow: hidden;
		}

		.container {
			width: calc(100vw - 5px);
			height: calc(100vh - 80px);
			display: flex;
		}

		.content {
			margin: 8px 0 0 0;
			flex-grow: 1;
		}
	</style>
</head>
<body>
	<div id="container">
		<div id="toolbar"></div> 
		<div class="content" id="spreadsheet1"></div>
	</div>

	<script>
	var spreadsheet1 = document.getElementById('spreadsheet1')
	var dataSourceNames = [];
	var downloadFormat = "TSV";

	function stringWidth(text) {
		const font = "16px sans-serif"	
		const canvas = document.createElement("canvas");	
		const context = canvas.getContext("2d");	
		context.font = font;	
		const { width } = context.measureText(text);	
		return width;
	}

	var loaded = function(instance) {
		function findLongestString(arr) {
			return arr.reduce((a, b)=> a.length > b.length ? a : b);
		}
		console.log('New data is loaded');
		const js = instance.jspreadsheet;
		const hMargin = 5;
		const headers = js.getHeaders().split(',');
		for(var i = 0; i<headers.length; i++) {
			const longestString = findLongestString(js.getColumnData(i));
			js.setWidth(i, Math.max(stringWidth(longestString), stringWidth(headers[i]))+2*hMargin);
		}
	}

	function addDataSource(dataSource) {
		const dataSourceName = dataSource.name;
		if(dataSourceNames.includes(dataSourceName)) {
			return;
		}
		dataSourceNames.push(dataSourceName);	
		jspreadsheet.tabs(spreadsheet1, [{
			sheetName: dataSourceName,
			csv: dataSource.uri,
			csvHeaders:true,
			tableOverflow:true,
			tableWidth:'100%',
			tableHeight:'89%',
			onload: loaded,
		}]);
	}

	function downloadSvFile(fileName, data) {
		var result;
		var mimetype = "text/csv";
		if(downloadFormat == "TSV") {
			result = d3.tsvFormatBody(data);
			mimetype = "text/tab-separated-values";
		} else result = d3.csvFormatBody(data);
		var hiddenA = document.createElement('a');
		hiddenA.href = 'data:'+mimetype+';charset=utf-8,' + encodeURI(result);
		hiddenA.target = '_blank';
		hiddenA.download = fileName+'.'+downloadFormat.toLowerCase();
		hiddenA.click();
	}

	function getCurrentJexcel() {
		if(!spreadsheet1.children[0]) return undefined;
		const worksheet = spreadsheet1.children[0].querySelector('.selected').getAttribute('data-spreadsheet');
		return spreadsheet1.jexcel[worksheet];
	}

	function getCurrentData() {
		const worksheet = spreadsheet1.children[0].querySelector('.selected').getAttribute('data-spreadsheet');
		const js = getCurrentJexcel();
		if(!js) return [];
		var data = js.getData();
		data.splice(0, 0, js.getHeaders().split(','));
		return data;
	}

	var download = function() {
		const data = getCurrentData();
		console.log(data);
		if(data.length==0) return;
		downloadSvFile("data", data);
	}

	function save() {
		console.log("Save data...");
	}

	function createToolbar(dataSources) {
		jSuites.toolbar(document.getElementById('toolbar'), {
			container: true,
			items:[
				{
					type: 'select',
					data: Object.keys(dataSources),
					onchange: function(a,b,c,d) { addDataSource(dataSources[d]); }
				},
				{
					type: 'icon',
					content: 'save',
					onclick: save
				},
				{
					type: 'select',
					data: ["TSV", "CSV"],
					onchange: function(a,b,c,d) { downloadFormat = d; }
				},
				{
					type: 'icon',
					content: 'vertical_align_bottom',
					onclick: download
				}
			]
		});
	}

	async function loadConfiguration() {
		const response = await fetch('config.json');
		const configuration = await response.json();
		console.log(configuration);
		const dataSources = configuration.dataSources;
		console.log(Object.keys(dataSources));
		createToolbar(dataSources);
	}

	loadConfiguration();

	</script>
</body>
</html>
