<html>
<head>
	
	<link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />
	<link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" /> 
	<script src="https://jsuites.net/v4/jsuites.js"></script>
	<script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/d3-dsv@3"></script>
	<!-- <script src="csv-lib.js"></script> -->

	<link rel="stylesheet" href="jexcel-custom.css" type="text/css" />

	<style>
		body, html {
			font-family: sans-serif;
			width: calc(100%-8px);
			height: 100%;
			overflow: hidden;
		}

		.container {
			width: calc(100vw - 5px);
			height: calc(100vh - 80px);
			display: flex;
		}

		.content {
			margin: 8px 0 0 0;
			flex-grow: 1;
		}
	</style>
</head>
<body>
	<div id="container">
		<div id="toolbar"></div> 
		<div class="content" id="spreadsheet1"></div>
	</div>

	<script>
	var spreadsheet1 = document.getElementById('spreadsheet1')
	var dataSourceNames = [];
	var downloadFormat = "TSV";

	function stringWidth(text) {
		const font = "16px sans-serif"	
		const canvas = document.createElement("canvas");	
		const context = canvas.getContext("2d");	
		context.font = font;	
		const { width } = context.measureText(text);	
		return width;
	}

	var loaded = function(instance) {
		function findLongestString(arr) {
			return arr.reduce((a, b)=> a.length > b.length ? a : b);
		}
		console.log('New data is loaded');
		const js = instance.jspreadsheet;
		const hMargin = 5;
		const headers = js.getHeaders().split(',');
		for(var i = 0; i<headers.length; i++) {
			var longestString = findLongestString(js.getColumnData(i));
			js.setWidth(i, Math.max(stringWidth(longestString), stringWidth(headers[i]))+2*hMargin);
		}
	}

	function addDs(dataSource) {
		const dataSourceName = dataSource.name;
		if(dataSourceNames.includes(dataSourceName)) {
			return;
		}
		dataSourceNames.push(dataSourceName);	
		jspreadsheet.tabs(spreadsheet1, [{
			sheetName: dataSourceName,
			csv: dataSource.uri,
			csvHeaders:true,
			tableOverflow:true,
			tableWidth:'100%',
			tableHeight:'89%',
			onload: loaded,
		}]);
	}

	function downloadCsvFile(fileName, data) {
		var csv = d3.tsvFormatBody(data);
		var hiddenA = document.createElement('a');
		hiddenA.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
		hiddenA.target = '_blank';
		hiddenA.download = fileName;
		hiddenA.click();
	}

	function getCurrentData() {
		const worksheet = spreadsheet1.children[0].querySelector('.selected').getAttribute('data-spreadsheet');
		const js = spreadsheet1.jexcel[worksheet];
		var data = js.getData();
		data.splice(0, 0, js.getHeaders().split(','));
		return data;
	}

	var download = function() {
		const data = getCurrentData();
		console.log(data);
		downloadCsvFile("data.csv", data);
	}

	function save() {
		console.log("Save data...");
	}

	function createToolbar(dataSources) {
		jSuites.toolbar(document.getElementById('toolbar'), {
			container: true,
			items:[
				{
					type: 'label',
					content: 'Load Data',
					onclick: function() {
						console.log('action');
					}
				},
				{
					type: 'select',
					data: Object.keys(dataSources),
					onchange: function(a,b,c,d) {
						addDs(dataSources[d]);
					}
				},
				{
					type: 'label',
					content: 'Save changes...',
					onclick: save
				},
				{
					type: 'select',
					data: ["TSV", "CSV"],
					onchange: function(a,b,c,d) {
						downloadFormat = d;
					}
				},
				{
					type: 'label',
					content: 'Download CSV',
					onclick: download
				}
			]
		});
	}

	async function loadDsList() {
		const response = await fetch('config.json');
		const configuration = await response.json();
		console.log(configuration);
		const dataSources = configuration.dataSources;
		console.log(Object.keys(dataSources));
		createToolbar(dataSources);
	}

	loadDsList();

	</script>
</body>
</html>
