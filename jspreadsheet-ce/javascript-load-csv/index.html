<html>
<head>
	
	<link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />
	<link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" /> 
	<script src="https://jsuites.net/v4/jsuites.js"></script>
	<script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>

	<link rel="stylesheet" href="jexcel-custom.css" type="text/css" />

	<style>
		body, html {
			font-family: sans-serif;
			width: calc(100%-8px);
			height: 100%;
			overflow: hidden;
		}

		.container {
			width: calc(100vw - 5px);
			height: calc(100vh - 80px);
			display: flex;
		}

		.content {
			flex-grow: 1;
		}
	</style>
</head>
<body>
	<div id="container">
		<div id="toolbar"></div> 
		<div class="content" id="spreadsheet1"></div>
	</div>

	<script>
	var spreadsheet1 = document.getElementById('spreadsheet1')
	var dataSources = [];

	function stringWidth(text) {
		const font = "16px sans-serif"	
		const canvas = document.createElement("canvas");	
		const context = canvas.getContext("2d");	
		context.font = font;	
		const { width } = context.measureText(text);	
		return width;
	}

	var loaded = function(instance) {
		function findLongestString(arr) {
			return arr.reduce((a, b)=> a.length > b.length ? a : b);
		}
		console.log('New data is loaded');
		const js = instance.jspreadsheet;
		const hMargin = 5;
		let headers = js.getHeaders().split(',');
		for(var i = 0; i<headers.length; i++) {
			var longestString = findLongestString(js.getColumnData(i));
			js.setWidth(i, Math.max(stringWidth(longestString), stringWidth(headers[i]))+2*hMargin);
		}
	}

	function addDs(dataSource) {
		if(dataSources.includes(dataSource)) {
			return;
		}
		dataSources.push(dataSource);	
		jspreadsheet.tabs(spreadsheet1, [{
			sheetName: dataSource,
			csv: 'data/'+dataSource+'.csv',
			csvHeaders:true,
			tableOverflow:true,
			tableWidth:'100%',
			tableHeight:'89%',
			onload: loaded,
		}]);
	}

	var download = function() {
		var worksheet = spreadsheet1.children[0].querySelector('.selected').getAttribute('data-spreadsheet');
		spreadsheet1.jexcel[worksheet].download();
	}

	function save() {
		console.log("Save data...");
	}

	jSuites.toolbar(document.getElementById('toolbar'), {
		container: true,
		items:[
			{
				type: 'label',
				content: 'Load Data',
				onclick: function() {
					console.log('action');
				}
			},
			{
				type: 'select',
				data: [ 'museums', 'cities', 'mlb_players' ],
				width: '160px',
				onchange: function(a,b,c,d) {
					addDs(d);
				}
			},
			{
				type: 'label',
				content: 'Save changes...',
				onclick: save
			},
			{
				type: 'label',
				content: 'Download CSV',
				onclick: download
			}
		]
	});
	</script>
</body>
</html>
